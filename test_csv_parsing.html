<!DOCTYPE html>
<html>
<head>
    <title>CSV Parsing Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test-section { margin: 20px 0; border: 1px solid #ccc; padding: 10px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🧪 CSV Parsing Test Suite</h1>
    
    <div class="test-section">
        <h2>Test 1: Multi-line Quoted Fields</h2>
        <div id="test1-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Date Preservation</h2>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Field Discovery</h2>
        <div id="test3-result"></div>
    </div>

    <script src="js/flux/repositories/SignalsRepository.js"></script>
    <script>
        // Test suite for CSV parsing improvements
        
        function runTest1() {
            console.log('🧪 Running Test 1: Multi-line Quoted Fields');
            
            // Sample CSV with embedded newlines in quoted fields
            const testCSV = `"Signal Id","Account Id","account_name","summary","created_at","Signal Polarity"
"SIG001","ACC001","Test Account","This is a summary
with multiple lines
and various content","2024-09-12T10:30:00Z","Positive"
"SIG002","ACC002","Another Account","Single line summary","2024-09-11T15:45:00Z","Negative"
"SIG003","ACC003","Multi Account","Complex summary with
embedded quotes ""like this"" and
multiple lines of text","2024-09-10T08:15:00Z","Neutral"`;
            
            try {
                const result = SignalsRepository.tokenizeCSV(testCSV);
                
                const test1Result = document.getElementById('test1-result');
                let output = '<div class="success">✅ Tokenization completed successfully!</div>';
                
                output += `<div class="info">📊 Parsed ${result.length} rows (including header)</div>`;
                output += `<div class="info">📋 Header row has ${result[0].length} columns</div>`;
                
                // Check if multi-line fields are handled correctly
                const row1 = result[1]; // First data row
                const summaryField = row1[3]; // summary column
                
                if (summaryField.includes('\n')) {
                    output += '<div class="success">✅ Multi-line fields preserved correctly</div>';
                    output += `<div class="info">📝 Summary field content: <pre>${summaryField}</pre></div>`;
                } else {
                    output += '<div class="error">❌ Multi-line fields not preserved</div>';
                }
                
                // Check embedded quotes handling
                const row3 = result[3]; // Third data row
                const summaryField3 = row3[3];
                if (summaryField3.includes('"like this"')) {
                    output += '<div class="success">✅ Embedded quotes handled correctly</div>';
                } else {
                    output += '<div class="error">❌ Embedded quotes not handled correctly</div>';
                }
                
                test1Result.innerHTML = output;
                
            } catch (error) {
                document.getElementById('test1-result').innerHTML = 
                    `<div class="error">❌ Test failed: ${error.message}</div>`;
            }
        }
        
        function runTest2() {
            console.log('🧪 Running Test 2: Date Preservation');
            
            const testCSV = `"Signal Id","account_name","created_at","created_date"
"SIG001","Test Account","2024-09-12T10:30:00Z","2024-09-12"
"SIG002","Another Account","2024-09-11T15:45:00Z","2024-09-11"`;
            
            try {
                const parsedData = SignalsRepository.parseCSV(testCSV);
                
                const test2Result = document.getElementById('test2-result');
                let output = '<div class="success">✅ CSV parsing completed!</div>';
                
                // Check if dates are preserved from CSV instead of being overridden
                const signal1 = parsedData[0];
                const expectedDate = '2024-09-12T10:30:00Z';
                
                if (signal1.created_at === expectedDate || signal1.created_date.includes('2024-09-12')) {
                    output += '<div class="success">✅ Original CSV dates preserved</div>';
                    output += `<div class="info">📅 created_at: ${signal1.created_at}</div>`;
                    output += `<div class="info">📅 created_date: ${signal1.created_date}</div>`;
                } else {
                    output += '<div class="error">❌ Dates were overridden with random values</div>';
                    output += `<div class="error">📅 Got created_at: ${signal1.created_at}</div>`;
                    output += `<div class="error">📅 Got created_date: ${signal1.created_date}</div>`;
                }
                
                test2Result.innerHTML = output;
                
            } catch (error) {
                document.getElementById('test2-result').innerHTML = 
                    `<div class="error">❌ Test failed: ${error.message}</div>`;
            }
        }
        
        function runTest3() {
            console.log('🧪 Running Test 3: Field Discovery');
            
            // CSV with fields that appear in different rows
            const testCSV = `"Signal Id","account_name","field_a","field_b","field_c"
"SIG001","Test Account","value1","","" 
"SIG002","Another Account","","value2",""
"SIG003","Third Account","","","value3"`;
            
            try {
                const parsedData = SignalsRepository.parseCSV(testCSV);
                
                const test3Result = document.getElementById('test3-result');
                let output = '<div class="success">✅ Field discovery test completed!</div>';
                
                // Check if all fields are discovered across multiple records
                const allExtras = new Set();
                parsedData.forEach(signal => {
                    if (signal.extras) {
                        Object.keys(signal.extras).forEach(field => allExtras.add(field));
                    }
                });
                
                const discoveredFields = Array.from(allExtras).sort();
                output += `<div class="info">🔍 Discovered fields: [${discoveredFields.join(', ')}]</div>`;
                
                // Should discover field_a, field_b, field_c since they appear in different rows
                const expectedFields = ['field_a', 'field_b', 'field_c'];
                const foundAll = expectedFields.every(field => discoveredFields.includes(field));
                
                if (foundAll) {
                    output += '<div class="success">✅ All fields discovered across multiple records</div>';
                } else {
                    output += '<div class="error">❌ Some fields were missed</div>';
                    output += `<div class="error">Expected: [${expectedFields.join(', ')}]</div>`;
                }
                
                test3Result.innerHTML = output;
                
            } catch (error) {
                document.getElementById('test3-result').innerHTML = 
                    `<div class="error">❌ Test failed: ${error.message}</div>`;
            }
        }
        
        // Run all tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                runTest1();
                runTest2(); 
                runTest3();
            }, 100);
        });
    </script>
</body>
</html>